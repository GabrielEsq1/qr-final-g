<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificaci贸n de Promotores CCB</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.4;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: white;
      padding: 15px 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      color: #2c5aa0;
      font-size: 24px;
      font-weight: bold;
    }
    
    .user-info {
      display: flex;
      gap: 15px;
    }
    
    .user-info a {
      color: #2c5aa0;
      text-decoration: none;
      font-size: 14px;
    }
    
    .user-info a:hover {
      text-decoration: underline;
    }
    
    .search-section {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #2c5aa0;
      font-size: 18px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .op-input {
      font-size: 18px;
      font-weight: bold;
      color: #2c5aa0;
      border: 1px solid #ddd;
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      width: 150px;
    }
    
    .op-input:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .search-hint {
      color: #666;
      font-size: 12px;
      margin-bottom: 15px;
    }
    
    .search-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 8px 16px;
      border: 1px solid #2c5aa0;
      background-color: white;
      color: #2c5aa0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn:hover {
      background-color: #f0f5ff;
    }
    
    .table-container {
      background-color: white;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background-color: #2c5aa0;
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: bold;
      font-size: 14px;
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .op-cell {
      font-weight: bold;
      color: #2c5aa0;
    }
    
    .action-link {
      color: #2c5aa0;
      text-decoration: none;
      margin-right: 10px;
    }
    
    .action-link:hover {
      text-decoration: underline;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      color: #666;
      font-size: 12px;
    }
    
    .alert {
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }
    
    .alert-error {
      background-color: #ffe6e6;
      color: #cc0000;
      border: 1px solid #ffcccc;
    }
    
    .alert-success {
      background-color: #e6ffe6;
      color: #006600;
      border: 1px solid #ccffcc;
    }
    
    .export-section {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <h1>Verificaci贸n de Promotores CCB</h1>
        
      </div>
    </header>
    
    <section class="search-section">
      <h2>Buscar por OP:</h2>
      <div class="search-box">
        <input type="text" id="op-input" class="op-input" placeholder="EX-0785" value="EX-0785">
      </div>
      <div class="search-hint">Acepta EX-0777, e00777, EX-0777...</div>
      
      <div class="search-buttons">
        <button id="search-btn" class="btn">Buscar</button>
        <button onclick="openQRScanner()" class="btn"> Escanear QR</button>
        <button id="clear-btn" class="btn">Limpiar</button>
      </div>
      
      <div id="alert" class="alert"></div>
    </section>

    <div class="export-section">
      <button onclick="exportToExcel()" class="btn">Exportar a Excel</button>
    </div>
    
    <section class="table-container">
      <table id="results-table">
        <thead>
          <tr>
            <th>OP</th>
            <th>CLIENTE</th>
            <th>NOMBRE</th>
            <th>DESCRIPCIN</th>
            <th>CANTIDAD</th>
            <th>TALLA</th>
            <th>QR</th>
            <th>ENLACE</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <tr>
            <td colspan="8" style="text-align: center; padding: 2rem;">Ingrese un OP para buscar</td>
          </tr>
        </tbody>
      </table>
    </section>
    
    <footer>
      <p>漏 2025 CCB - Todos los derechos reservados.</p>
    </footer>
  </div>

  <script>
    // Funci贸n para abrir el lector QR
    function openQRScanner() {
        // Abrir el lector QR en una nueva ventana
        const qrWindow = window.open('/static/lectordeqr.html', 'qrScanner', 
            'width=600,height=700,scrollbars=no,resizable=yes');
        
        // Escuchar mensajes del lector QR
        window.addEventListener('message', function(event) {
            // Verificar que el mensaje viene del lector QR
            if (event.data && event.data.type === 'QR_RESULT') {
                const qrData = event.data.value;
                document.getElementById('op-input').value = qrData;
                searchOP(); // Buscar autom谩ticamente
                
                // Cerrar la ventana del lector QR
                if (qrWindow && !qrWindow.closed) {
                    qrWindow.close();
                }
            }
        });
        
        showAlert('Se abrir谩 el lector QR. Escanea el c贸digo y se cerrar谩 autom谩ticamente.', 'success');
    }

    function showAlert(message, type = 'error') {
      const alertDiv = document.getElementById('alert');
      if (!alertDiv) return;
      
      alertDiv.textContent = message;
      alertDiv.className = `alert alert-${type}`;
      alertDiv.style.display = 'block';
      
      setTimeout(() => {
        alertDiv.style.display = 'none';
      }, 5000);
    }

    async function searchOP() {
      const opInput = document.getElementById('op-input');
      if (!opInput) return;
      
      const opValue = opInput.value.trim();
      
      if (!opValue) {
        showAlert('Por favor, ingrese un OP para buscar');
        return;
      }
      
      try {
        showAlert('Buscando...', 'success');
        
        const response = await fetch(`/api/promotores?op=${encodeURIComponent(opValue)}`);
        const data = await response.json();
        
        if (!data.ok) {
          showAlert(data.error);
          return;
        }
        
        displayResults(data.data.records);
        
        if (data.data.records.length === 0) {
          showAlert(`No se encontraron resultados para el OP: ${opValue}`);
        } else {
          showAlert(`Se encontraron ${data.data.records.length} resultado(s)`, 'success');
        }
      } catch (error) {
        console.error('Error en b煤squeda:', error);
        showAlert('Error al conectar con el servidor');
      }
    }

    function displayResults(results) {
      const resultsBody = document.getElementById('results-body');
      if (!resultsBody) return;
      
      resultsBody.innerHTML = '';
      
      if (results.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="8" style="text-align: center; padding: 2rem;">No se encontraron resultados</td>`;
        resultsBody.appendChild(row);
        return;
      }
      
      results.forEach(item => {
        const row = document.createElement('tr');
        
        let enlaceButtons = '';
        if (item.enlace && item.enlace.trim() !== '') {
          const enlace = item.enlace.trim();
          const enlaceSafe = enlace.replace(/'/g, "&#39;");
          enlaceButtons = `
            <a href="${enlace}" target="_blank" class="action-link">Abrir</a>
            <a href="#" class="action-link" onclick="copyToClipboard('${enlaceSafe}')">Copiar</a>
          `;
        }
        
        row.innerHTML = `
          <td class="op-cell">${item.op || ''}</td>
          <td>${item.cliente || ''}</td>
          <td>${item.nombre || ''}</td>
          <td>${item.descripcion || ''}</td>
          <td>${item.cantidad || ''}</td>
          <td>${item.talla || ''}</td>
          <td>${item.qr || ''}</td>
          <td>${enlaceButtons}</td>
        `;
        resultsBody.appendChild(row);
      });
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => {
          showAlert('Enlace copiado al portapapeles', 'success');
        })
        .catch(err => {
          console.error('Error al copiar:', err);
          showAlert('Error al copiar el enlace');
        });
    }

    function clearSearch() {
      const opInput = document.getElementById('op-input');
      if (opInput) {
        opInput.value = '';
      }
      
      const alertDiv = document.getElementById('alert');
      if (alertDiv) {
        alertDiv.style.display = 'none';
      }
      
      displayResults([]);
    }

    function exportToExcel() {
      const resultsBody = document.getElementById('results-body');
      if (!resultsBody) return;
      
      const rows = resultsBody.querySelectorAll('tr');
      
      if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('td[colspan="8"]'))) {
        showAlert('No hay datos para exportar');
        return;
      }
      
      let csv = [];
      csv.push('"OP","CLIENTE","NOMBRE","DESCRIPCIN","CANTIDAD","TALLA","QR","ENLACE"');
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 8) {
          const rowData = [];
          cells.forEach((cell, index) => {
            let text = cell.textContent.trim();
            if (index === 7) {
              text = '';
            }
            text = text.replace(/"/g, '""');
            rowData.push(`"${text}"`);
          });
          csv.push(rowData.join(','));
        }
      });
      
      const csvContent = csv.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `promotores_ccb_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('Datos exportados correctamente', 'success');
    }

    // Inicializaci贸n
    function initializeApp() {
      const searchBtn = document.getElementById('search-btn');
      if (searchBtn) {
        searchBtn.addEventListener('click', searchOP);
      }
      
      const opInput = document.getElementById('op-input');
      if (opInput) {
        opInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            searchOP();
          }
        });
      }
      
      const clearBtn = document.getElementById('clear-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', clearSearch);
      }
    }

    // Hacer funciones globales
    window.searchOP = searchOP;
    window.clearSearch = clearSearch;
    window.exportToExcel = exportToExcel;
    window.copyToClipboard = copyToClipboard;
    window.openQRScanner = openQRScanner;

    // Inicializar cuando el DOM est茅 listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>